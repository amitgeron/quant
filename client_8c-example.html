<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>quant: client.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">quant
   &#160;<span id="projectnumber">0.0.16</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">client.c</div>  </div>
</div><!--header-->
<div class="contents">
<p>)</p>
<div class="fragment"><div class="line"><span class="comment">// SPDX-License-Identifier: BSD-2-Clause</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Copyright (c) 2016-2018, NetApp, Inc.</span></div>
<div class="line"><span class="comment">// All rights reserved.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Redistribution and use in source and binary forms, with or without</span></div>
<div class="line"><span class="comment">// modification, are permitted provided that the following conditions are met:</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// 1. Redistributions of source code must retain the above copyright notice,</span></div>
<div class="line"><span class="comment">//    this list of conditions and the following disclaimer.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// 2. Redistributions in binary form must reproduce the above copyright notice,</span></div>
<div class="line"><span class="comment">//    this list of conditions and the following disclaimer in the documentation</span></div>
<div class="line"><span class="comment">//    and/or other materials provided with the distribution.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;</span></div>
<div class="line"><span class="comment">// AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span></div>
<div class="line"><span class="comment">// IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span></div>
<div class="line"><span class="comment">// ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE</span></div>
<div class="line"><span class="comment">// LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span></div>
<div class="line"><span class="comment">// CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span></div>
<div class="line"><span class="comment">// SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span></div>
<div class="line"><span class="comment">// INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span></div>
<div class="line"><span class="comment">// CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span></div>
<div class="line"><span class="comment">// ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span></div>
<div class="line"><span class="comment">// POSSIBILITY OF SUCH DAMAGE.</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;fcntl.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;inttypes.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;net/if.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;netdb.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;netinet/in.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdbool.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/param.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/socket.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/types.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;http_parser.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="quant_8h.html">quant/quant.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;warpcore/warpcore.h&gt;</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>conn_cache_entry {</div>
<div class="line">    <span class="keyword">struct </span>sockaddr_in dst;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a0"></a><a class="code" href="structq__conn.html">q_conn</a> * c;</div>
<div class="line">    <a name="a1"></a><a class="code" href="structq__conn.html#af17440ad2ae4dd9965ebab0950de86af">splay_entry</a>(conn_cache_entry) node;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>conn_cache {</div>
<div class="line">    <a name="a2"></a><a class="code" href="conn_8h.html#ae0ffc6a0951e8dd9d83508555b396b9d">splay_head</a>(, conn_cache_entry);</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> uint64_t timeout = 10;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> do_h3 = <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> uint32_t __attribute__((nonnull))</div>
<div class="line">conn_cmp(const struct conn_cache_entry * const a,</div>
<div class="line">         const struct conn_cache_entry * const b)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> uint32_t diff = (a-&gt;dst.sin_addr.s_addr &gt; b-&gt;dst.sin_addr.s_addr) -</div>
<div class="line">                          (a-&gt;dst.sin_addr.s_addr &lt; b-&gt;dst.sin_addr.s_addr);</div>
<div class="line">    <span class="keywordflow">if</span> (diff)</div>
<div class="line">        <span class="keywordflow">return</span> diff;</div>
<div class="line">    <span class="keywordflow">return</span> (a-&gt;dst.sin_port &gt; b-&gt;dst.sin_port) -</div>
<div class="line">           (a-&gt;dst.sin_port &lt; b-&gt;dst.sin_port);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">SPLAY_PROTOTYPE(conn_cache, conn_cache_entry, node, conn_cmp)</div>
<div class="line">SPLAY_GENERATE(conn_cache, conn_cache_entry, node, conn_cmp)</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">struct stream_entry {</div>
<div class="line">    sl_entry(stream_entry) next;</div>
<div class="line">    struct <a class="code" href="structq__conn.html">q_conn</a> * c;</div>
<div class="line">    struct <a name="_a3"></a><a class="code" href="structq__stream.html">q_stream</a> * s;</div>
<div class="line">    <span class="keywordtype">char</span> * url;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">static <a name="a4"></a><a class="code" href="conn_8h.html#addd27b7fdfd0f22d4c24b474c8738213">sl_head</a>(stream_list, stream_entry) sl = sl_head_initializer(sl);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">static <span class="keywordtype">void</span> __attribute__((noreturn, nonnull)) usage(const <span class="keywordtype">char</span> * const name,</div>
<div class="line">                                                     const <span class="keywordtype">char</span> * const ifname,</div>
<div class="line">                                                     const <span class="keywordtype">char</span> * const cache,</div>
<div class="line">                                                     const <span class="keywordtype">char</span> * const tls_log,</div>
<div class="line">                                                     const <span class="keywordtype">bool</span> verify_certs,</div>
<div class="line">                                                     const uint64_t upd_amnt)</div>
<div class="line">{</div>
<div class="line">    printf(<span class="stringliteral">&quot;%s [options] URL\n&quot;</span>, name);</div>
<div class="line">    printf(<span class="stringliteral">&quot;\t[-i interface]\tinterface to run over; default %s\n&quot;</span>, ifname);</div>
<div class="line">    printf(<span class="stringliteral">&quot;\t[-s cache]\tTLS 0-RTT state cache; default %s\n&quot;</span>, cache);</div>
<div class="line">    printf(<span class="stringliteral">&quot;\t[-l log]\tlog file for TLS keys; default %s\n&quot;</span>, tls_log);</div>
<div class="line">    printf(<span class="stringliteral">&quot;\t[-t timeout]\tidle timeout in seconds; default %&quot;</span> PRIu64 <span class="stringliteral">&quot;\n&quot;</span>,</div>
<div class="line">           timeout);</div>
<div class="line">    printf(<span class="stringliteral">&quot;\t[-c]\t\tverify TLS certificates; default %s\n&quot;</span>,</div>
<div class="line">           verify_certs ? <span class="stringliteral">&quot;true&quot;</span> : <span class="stringliteral">&quot;false&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;\t[-u bytes]\tupdate TLS keys after this traffic volume; default &quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;%&quot;</span> PRIu64 <span class="stringliteral">&quot;\n&quot;</span>,</div>
<div class="line">           upd_amnt);</div>
<div class="line">    printf(<span class="stringliteral">&quot;\t[-3]\t\tsend a static H3 request; default %s\n&quot;</span>,</div>
<div class="line">           do_h3 ? <span class="stringliteral">&quot;true&quot;</span> : <span class="stringliteral">&quot;false&quot;</span>);</div>
<div class="line"><span class="preprocessor">#ifndef NDEBUG</span></div>
<div class="line"><span class="preprocessor"></span>    printf(<span class="stringliteral">&quot;\t[-v verbosity]\tverbosity level (0-%d, default %d)\n&quot;</span>, DLEVEL,</div>
<div class="line">           util_dlevel);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>    exit(0);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> __attribute__((nonnull))</div>
<div class="line">set_from_url(<span class="keywordtype">char</span> * const var,</div>
<div class="line">             const <span class="keywordtype">size_t</span> len,</div>
<div class="line">             const <span class="keywordtype">char</span> * const url,</div>
<div class="line">             const struct http_parser_url * const u,</div>
<div class="line">             const enum http_parser_url_fields f,</div>
<div class="line">             const <span class="keywordtype">char</span> * const def)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> ((u-&gt;field_set &amp; (1 &lt;&lt; f)) == 0) {</div>
<div class="line">        strncpy(var, def, len);</div>
<div class="line">        var[len - 1] = 0;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        strncpy(var, &amp;url[u-&gt;field_data[f].off], u-&gt;field_data[f].len);</div>
<div class="line">        var[u-&gt;field_data[f].len] = 0;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structq__conn.html">q_conn</a> * __attribute__((nonnull))</div>
<div class="line">get(struct w_engine * const <a name="a5"></a><a class="code" href="structq__conn.html#a3f244414e35b3f452821cc6ceb2af485">w</a>,</div>
<div class="line">    struct conn_cache * const cc,</div>
<div class="line">    const <span class="keywordtype">char</span> * const dest,</div>
<div class="line">    const <span class="keywordtype">char</span> * const port,</div>
<div class="line">    const <span class="keywordtype">char</span> * const path)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>addrinfo * peer;</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">struct </span>addrinfo hints = {.ai_family = PF_INET,</div>
<div class="line">                                   .ai_socktype = SOCK_DGRAM,</div>
<div class="line">                                   .ai_protocol = IPPROTO_UDP};</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> err = getaddrinfo(dest, port, &amp;hints, &amp;peer);</div>
<div class="line">    <span class="keywordflow">if</span> (err) {</div>
<div class="line">        warn(ERR, <span class="stringliteral">&quot;getaddrinfo: %s&quot;</span>, gai_strerror(err));</div>
<div class="line">        freeaddrinfo(peer);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// add to stream list</span></div>
<div class="line">    <span class="keyword">struct </span>stream_entry * se = calloc(1, <span class="keyword">sizeof</span>(*se));</div>
<div class="line">    ensure(se, <span class="stringliteral">&quot;calloc failed&quot;</span>);</div>
<div class="line">    sl_insert_head(&amp;sl, se, next);</div>
<div class="line"></div>
<div class="line">    <span class="keyword">struct </span>w_iov_sq req = w_iov_sq_initializer(req);</div>
<div class="line">    <span class="keywordflow">if</span> (do_h3) {</div>
<div class="line">        <span class="comment">// static const uint8_t h3_get_large[] = {</span></div>
<div class="line">        <span class="comment">//     0x01, 0x00, 0x00, 0xd1, 0x5f, 0x07, 0x04, 0x48, 0x54, 0x54, 0x50,</span></div>
<div class="line">        <span class="comment">//     0x51, 0x87, 0x62, 0x53, 0x50, 0x55, 0x84, 0x0c, 0xdf, 0x50, 0x8f,</span></div>
<div class="line">        <span class="comment">//     0xf1, 0xe3, 0xc2, 0xf4, 0x19, 0x25, 0x45, 0x65, 0x2c, 0x89, 0x29,</span></div>
<div class="line">        <span class="comment">//     0x27, 0x5c, 0x87, 0xa7, 0x5f, 0x50, 0x93, 0xce, 0x3b, 0x10, 0xa6,</span></div>
<div class="line">        <span class="comment">//     0x09, 0xa6, 0x2d, 0x89, 0xff, 0x48, 0x52, 0x91, 0xcc, 0x62, 0x29,</span></div>
<div class="line">        <span class="comment">//     0x1f, 0xa4, 0x95, 0x1f};</span></div>
<div class="line"></div>
<div class="line">        <span class="comment">// use a canned H/3 request that is equivalent of &quot;GET /&quot;</span></div>
<div class="line">        <span class="keyword">static</span> <span class="keyword">const</span> uint8_t h3_get_slash[] = {</div>
<div class="line">            0x32, 0x01, 0x00, 0x00, 0xd1, 0x5f, 0x07, 0x04, 0x48, 0x54, 0x54,</div>
<div class="line">            0x50, 0xc1, 0x50, 0x8f, 0xf1, 0xe3, 0xc2, 0xf4, 0x19, 0x25, 0x45,</div>
<div class="line">            0x65, 0x2c, 0x89, 0x29, 0x27, 0x5c, 0x87, 0xa7, 0x5f, 0x50, 0x93,</div>
<div class="line">            0xce, 0x3b, 0x10, 0xa6, 0x09, 0xa6, 0x2d, 0x89, 0xff, 0x48, 0x52,</div>
<div class="line">            0x91, 0xcc, 0x62, 0x29, 0x1f, 0xa4, 0x95, 0x1f};</div>
<div class="line">        <a name="a6"></a><a class="code" href="quant_8h.html#a259552347b2ef970bf6955dd5995449a">q_chunk_str</a>(w, (<span class="keyword">const</span> <span class="keywordtype">char</span> *)h3_get_slash, <span class="keyword">sizeof</span>(h3_get_slash), &amp;req);</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        <span class="comment">// assemble an HTTP/0.9 request</span></div>
<div class="line">        <span class="keywordtype">char</span> req_str[MAXPATHLEN + 6];</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">int</span> req_str_len =</div>
<div class="line">            snprintf(req_str, <span class="keyword">sizeof</span>(req_str), <span class="stringliteral">&quot;GET %s\r\n&quot;</span>, path);</div>
<div class="line">        <a class="code" href="quant_8h.html#a259552347b2ef970bf6955dd5995449a">q_chunk_str</a>(w, req_str, (uint32_t)req_str_len, &amp;req);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// do we have a connection open to this peer?</span></div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">struct </span>conn_cache_entry which = {</div>
<div class="line">        .dst = *(<span class="keyword">struct </span>sockaddr_in *)&amp;peer-&gt;ai_addr};</div>
<div class="line">    <span class="keyword">struct </span>conn_cache_entry * cce = splay_find(conn_cache, cc, &amp;which);</div>
<div class="line">    <span class="keywordflow">if</span> (cce == 0) {</div>
<div class="line">        <span class="comment">// no, open a new connection</span></div>
<div class="line">        <span class="keyword">struct </span><a class="code" href="structq__conn.html">q_conn</a> * <span class="keyword">const</span> c =</div>
<div class="line">            <a name="a7"></a><a class="code" href="quant_8h.html#a8ada47f75ab8833467377ab6de61c320">q_connect</a>(w, (<span class="keyword">struct</span> sockaddr_in *)(<span class="keywordtype">void</span> *)peer-&gt;ai_addr, dest,</div>
<div class="line">                      &amp;req, &amp;se-&gt;s, <span class="keyword">true</span>, timeout);</div>
<div class="line">        <span class="keywordflow">if</span> (c == 0) {</div>
<div class="line">            freeaddrinfo(peer);</div>
<div class="line">            <span class="keywordflow">return</span> 0;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        cce = calloc(1, <span class="keyword">sizeof</span>(*cce));</div>
<div class="line">        ensure(cce, <span class="stringliteral">&quot;calloc failed&quot;</span>);</div>
<div class="line">        cce-&gt;c = c;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// insert into connection cache</span></div>
<div class="line">        cce-&gt;dst = *(<span class="keyword">struct </span>sockaddr_in *)&amp;peer-&gt;ai_addr;</div>
<div class="line">        splay_insert(conn_cache, cc, cce);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (do_h3) {</div>
<div class="line">            <span class="comment">// we need to open a uni stream for an empty H/3 SETTINGS frame</span></div>
<div class="line">            <span class="keyword">struct </span><a class="code" href="structq__stream.html">q_stream</a> * <span class="keyword">const</span> ss = <a name="a8"></a><a class="code" href="quant_8h.html#a7882234166a0aaac582c25c4c8a581b8">q_rsv_stream</a>(cce-&gt;c, <span class="keyword">false</span>);</div>
<div class="line">            <span class="keyword">static</span> <span class="keyword">const</span> uint8_t h3_empty_settings[] = {0x43, 0x00, 0x04};</div>
<div class="line">            <a name="a9"></a><a class="code" href="quant_8h.html#a3fe837399476c6ae443a5f17b5eb644f">q_write_str</a>(w, ss, (<span class="keyword">const</span> <span class="keywordtype">char</span> *)h3_empty_settings,</div>
<div class="line">                        <span class="keyword">sizeof</span>(h3_empty_settings), <span class="keyword">false</span>);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        se-&gt;s = <a class="code" href="quant_8h.html#a7882234166a0aaac582c25c4c8a581b8">q_rsv_stream</a>(cce-&gt;c, <span class="keyword">true</span>);</div>
<div class="line">        <a name="a10"></a><a class="code" href="quant_8h.html#a5c710c2093cc759f8bb581e25b52ceda">q_write</a>(se-&gt;s, &amp;req, <span class="keyword">true</span>);</div>
<div class="line">    }</div>
<div class="line">    se-&gt;c = cce-&gt;c;</div>
<div class="line">    se-&gt;url = strdup(path);</div>
<div class="line"></div>
<div class="line">    <a name="a11"></a><a class="code" href="quant_8h.html#a01444581bd34af25498d1cb8fc3a0a92">q_close_stream</a>(se-&gt;s);</div>
<div class="line">    freeaddrinfo(peer);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> cce-&gt;c; <span class="comment">// NOLINT</span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> __attribute__((nonnull)) free_cc(struct conn_cache * const cc)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>conn_cache_entry *i, *next;</div>
<div class="line">    <span class="keywordflow">for</span> (i = splay_min(conn_cache, cc); i != 0; i = next) {</div>
<div class="line">        next = splay_next(conn_cache, cc, i);</div>
<div class="line">        splay_remove(conn_cache, cc, i);</div>
<div class="line">        free(i);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> free_sl(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>stream_entry *i = 0, *tmp = 0;</div>
<div class="line">    sl_foreach_safe (i, &amp;sl, next, tmp) {</div>
<div class="line">        sl_remove(&amp;sl, i, stream_entry, next);</div>
<div class="line">        free(i-&gt;url);</div>
<div class="line">        free(i);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> * argv[])</div>
<div class="line">{</div>
<div class="line"><span class="preprocessor">#ifndef NDEBUG</span></div>
<div class="line"><span class="preprocessor"></span>    util_dlevel = DLEVEL; <span class="comment">// default to maximum compiled-in verbosity</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordtype">char</span> ifname[IFNAMSIZ] = <span class="stringliteral">&quot;lo&quot;</span></div>
<div class="line"><span class="preprocessor">#ifndef __linux__</span></div>
<div class="line"><span class="preprocessor"></span>                            <span class="stringliteral">&quot;0&quot;</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>        ;</div>
<div class="line">    <span class="keywordtype">int</span> ch;</div>
<div class="line">    <span class="keywordtype">char</span> cache[MAXPATHLEN] = <span class="stringliteral">&quot;/tmp/&quot;</span> <a name="a12"></a><a class="code" href="config_8h.html#a12c9d614554664180937dfc530273668">QUANT</a> <span class="stringliteral">&quot;-session&quot;</span>;</div>
<div class="line">    <span class="keywordtype">char</span> tls_log[MAXPATHLEN] = <span class="stringliteral">&quot;/tmp/&quot;</span> <a class="code" href="config_8h.html#a12c9d614554664180937dfc530273668">QUANT</a> <span class="stringliteral">&quot;-tlslog&quot;</span>;</div>
<div class="line">    <span class="keywordtype">bool</span> verify_certs = <span class="keyword">false</span>;</div>
<div class="line">    uint64_t upd_amnt = 0;</div>
<div class="line">    <span class="keywordtype">int</span> ret = 0;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> ((ch = getopt(argc, argv, <span class="stringliteral">&quot;hi:v:s:t:cu:3&quot;</span>)) != -1) {</div>
<div class="line">        <span class="keywordflow">switch</span> (ch) {</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;i&#39;</span>:</div>
<div class="line">            strncpy(ifname, optarg, <span class="keyword">sizeof</span>(ifname) - 1);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;s&#39;</span>:</div>
<div class="line">            strncpy(cache, optarg, <span class="keyword">sizeof</span>(cache) - 1);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;t&#39;</span>:</div>
<div class="line">            timeout = MIN(<a name="a13"></a><a class="code" href="quant_8h.html#a05a1fe5d96137d7166715a45aebf6dc8">IDLE_TIMEOUT_MAX</a>, strtoul(optarg, 0, 10));</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;l&#39;</span>:</div>
<div class="line">            strncpy(tls_log, optarg, <span class="keyword">sizeof</span>(tls_log) - 1);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;c&#39;</span>:</div>
<div class="line">            verify_certs = <span class="keyword">true</span>;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;u&#39;</span>:</div>
<div class="line">            upd_amnt = MIN(UINT32_MAX, strtoul(optarg, 0, 10));</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;3&#39;</span>:</div>
<div class="line">            do_h3 = <span class="keyword">true</span>;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;v&#39;</span>:</div>
<div class="line"><span class="preprocessor">#ifndef NDEBUG</span></div>
<div class="line"><span class="preprocessor"></span>            util_dlevel = (short)MIN(DLEVEL, strtoul(optarg, 0, 10));</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;h&#39;</span>:</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;?&#39;</span>:</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            usage(basename(argv[0]), ifname, cache, tls_log, verify_certs,</div>
<div class="line">                  upd_amnt);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">struct </span>w_engine * <span class="keyword">const</span> w =</div>
<div class="line">        <a name="a14"></a><a class="code" href="quant_8h.html#a1b6e7bb1b1a84ea93291544464c5f3c5">q_init</a>(ifname, 0, 0, cache, tls_log, verify_certs, upd_amnt);</div>
<div class="line">    <span class="keyword">struct </span>conn_cache cc = splay_initializer(cc);</div>
<div class="line">    <span class="keyword">struct </span>http_parser_url u = {0};</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> (optind &lt; argc) {</div>
<div class="line">        <span class="comment">// parse and verify the URIs passed on the command line</span></div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">char</span> * <span class="keyword">const</span> url = argv[optind++];</div>
<div class="line">        http_parser_parse_url(url, strlen(url), 0, &amp;u);</div>
<div class="line">        ensure((u.field_set &amp; (1 &lt;&lt; UF_USERINFO)) == 0 &amp;&amp;</div>
<div class="line">                   (u.field_set &amp; (1 &lt;&lt; UF_QUERY)) == 0 &amp;&amp;</div>
<div class="line">                   (u.field_set &amp; (1 &lt;&lt; UF_FRAGMENT)) == 0,</div>
<div class="line">               <span class="stringliteral">&quot;unsupported URL components&quot;</span>);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// extract relevant info from URL</span></div>
<div class="line">        <span class="keywordtype">char</span> dest[1024], port[64], path[2048];</div>
<div class="line">        set_from_url(dest, <span class="keyword">sizeof</span>(dest), url, &amp;u, UF_HOST, <span class="stringliteral">&quot;localhost&quot;</span>);</div>
<div class="line">        set_from_url(port, <span class="keyword">sizeof</span>(port), url, &amp;u, UF_PORT, <span class="stringliteral">&quot;4433&quot;</span>);</div>
<div class="line">        set_from_url(path, <span class="keyword">sizeof</span>(path), url, &amp;u, UF_PATH, <span class="stringliteral">&quot;/index.html&quot;</span>);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// open a new connection, or get an open one</span></div>
<div class="line">        warn(INF, <span class="stringliteral">&quot;%s retrieving %s&quot;</span>, basename(argv[0]), url);</div>
<div class="line">        <span class="keywordflow">if</span> (<span class="keyword">get</span>(w, &amp;cc, dest, port, path) == 0) {</div>
<div class="line">            <span class="comment">// q_connect() failed</span></div>
<div class="line">            ret = 1;</div>
<div class="line">            <span class="keywordflow">goto</span> done;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// collect the replies</span></div>
<div class="line">    <span class="keyword">struct </span>stream_entry * se = 0;</div>
<div class="line">    sl_foreach (se, &amp;sl, next) {</div>
<div class="line">        <span class="comment">// read HTTP/0.9 reply and dump it to stdout</span></div>
<div class="line">        <span class="keyword">struct </span>w_iov_sq i = w_iov_sq_initializer(i);</div>
<div class="line">        <span class="keywordflow">if</span> (se-&gt;c == 0)</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line"></div>
<div class="line">        <a name="a15"></a><a class="code" href="quant_8h.html#afa40a9929151cdca1205f08b838e53f5">q_readall_str</a>(se-&gt;s, &amp;i);</div>
<div class="line">        <span class="keywordflow">if</span> (w_iov_sq_cnt(&amp;i) == 0) {</div>
<div class="line">            <span class="comment">// no data read</span></div>
<div class="line">            ret = 1;</div>
<div class="line">            <span class="keywordflow">goto</span> done;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">char</span> * <span class="keyword">const</span> slash = strrchr(se-&gt;url, <span class="charliteral">&#39;/&#39;</span>);</div>
<div class="line">        <span class="keywordflow">if</span> (slash &amp;&amp; *(slash + 1) == 0)</div>
<div class="line">            <span class="comment">// this URL ends in a slash, so strip that to name the file</span></div>
<div class="line">            *slash = 0;</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">int</span> fd =</div>
<div class="line">            open(*basename(se-&gt;url) == 0 ? <span class="stringliteral">&quot;index.html&quot;</span> : basename(se-&gt;url),</div>
<div class="line">                 O_CREAT | O_WRONLY | O_CLOEXEC, S_IRUSR | S_IWUSR | S_IRGRP);</div>
<div class="line">        ensure(fd != -1, <span class="stringliteral">&quot;cannot open %s&quot;</span>, basename(se-&gt;url));</div>
<div class="line"></div>
<div class="line">        <span class="comment">// save the object, and print its first three packets to stdout</span></div>
<div class="line">        <span class="keyword">struct </span>w_iov * v;</div>
<div class="line">        uint32_t n = 0;</div>
<div class="line">        sq_foreach (v, &amp;i, next) {</div>
<div class="line">            ensure(write(fd, v-&gt;buf, v-&gt;len) != -1, <span class="stringliteral">&quot;cannot write&quot;</span>);</div>
<div class="line">            <span class="keywordflow">if</span> (n &lt; 4 || v == sq_last(&amp;i, w_iov, next)) {</div>
<div class="line">                <span class="comment">// don&#39;t print newlines to console log</span></div>
<div class="line">                <span class="keywordflow">for</span> (uint16_t p = 0; p &lt; v-&gt;len; p++)</div>
<div class="line">                    <span class="keywordflow">if</span> (v-&gt;buf[p] == <span class="charliteral">&#39;\n&#39;</span> || v-&gt;buf[p] == <span class="charliteral">&#39;\r&#39;</span>)</div>
<div class="line">                        v-&gt;buf[p] = <span class="charliteral">&#39; &#39;</span>;</div>
<div class="line">                <span class="keywordflow">if</span> (do_h3)</div>
<div class="line">                    hexdump(v-&gt;buf, v-&gt;len);</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                    printf(<span class="stringliteral">&quot;%.*s&quot;</span>, v-&gt;len, v-&gt;buf);</div>
<div class="line">            } <span class="keywordflow">else</span></div>
<div class="line">                printf(<span class="stringliteral">&quot;.&quot;</span>);</div>
<div class="line">            n++;</div>
<div class="line">        }</div>
<div class="line">        printf(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">        close(fd);</div>
<div class="line">        <a name="a16"></a><a class="code" href="quant_8h.html#a4a7935a14e509d989eda300f16daf086">q_free</a>(&amp;i);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">done:</div>
<div class="line">    <a name="a17"></a><a class="code" href="quant_8h.html#a22f108de18d6532a45071881f7fb4dca">q_cleanup</a>(w);</div>
<div class="line">    free_cc(&amp;cc);</div>
<div class="line">    free_sl();</div>
<div class="line">    warn(DBG, <span class="stringliteral">&quot;%s exiting&quot;</span>, basename(argv[0]));</div>
<div class="line">    <span class="keywordflow">return</span> ret;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu Nov 8 2018 07:19:18 for quant by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
