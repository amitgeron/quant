<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>quant: server.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">quant
   &#160;<span id="projectnumber">0.0.17</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">server.c</div>  </div>
</div><!--header-->
<div class="contents">
<p>)</p>
<div class="fragment"><div class="line"><span class="comment">// SPDX-License-Identifier: BSD-2-Clause</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Copyright (c) 2016-2019, NetApp, Inc.</span></div>
<div class="line"><span class="comment">// All rights reserved.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Redistribution and use in source and binary forms, with or without</span></div>
<div class="line"><span class="comment">// modification, are permitted provided that the following conditions are met:</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// 1. Redistributions of source code must retain the above copyright notice,</span></div>
<div class="line"><span class="comment">//    this list of conditions and the following disclaimer.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// 2. Redistributions in binary form must reproduce the above copyright notice,</span></div>
<div class="line"><span class="comment">//    this list of conditions and the following disclaimer in the documentation</span></div>
<div class="line"><span class="comment">//    and/or other materials provided with the distribution.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;</span></div>
<div class="line"><span class="comment">// AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span></div>
<div class="line"><span class="comment">// IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span></div>
<div class="line"><span class="comment">// ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE</span></div>
<div class="line"><span class="comment">// LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span></div>
<div class="line"><span class="comment">// CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span></div>
<div class="line"><span class="comment">// SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span></div>
<div class="line"><span class="comment">// INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span></div>
<div class="line"><span class="comment">// CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span></div>
<div class="line"><span class="comment">// ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span></div>
<div class="line"><span class="comment">// POSSIBILITY OF SUCH DAMAGE.</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;fcntl.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;inttypes.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;net/if.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdbool.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/param.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/stat.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifndef __linux__</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/types.h&gt;</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#include &lt;http_parser.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="quant_8h.html">quant/quant.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="warpcore_8h.html">warpcore/warpcore.h</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>q_conn;</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> __attribute__((noreturn)) <a name="a0"></a><a class="code" href="esni_8c.html#af1307a35da9646ba048347321301c323">usage</a>(const <span class="keywordtype">char</span> * const name,</div>
<div class="line">                                            const <span class="keywordtype">char</span> * const ifname,</div>
<div class="line">                                            const uint16_t port,</div>
<div class="line">                                            const <span class="keywordtype">char</span> * const dir,</div>
<div class="line">                                            const <span class="keywordtype">char</span> * const cert,</div>
<div class="line">                                            const <span class="keywordtype">char</span> * const key,</div>
<div class="line">                                            const uint64_t <a name="a1"></a><a class="code" href="ping_8c.html#aae6e82a30c30cc902f1cd85dead37f6a">timeout</a>)</div>
<div class="line">{</div>
<div class="line">    printf(<span class="stringliteral">&quot;%s [options]\n&quot;</span>, name);</div>
<div class="line">    printf(<span class="stringliteral">&quot;\t[-i interface]\tinterface to run over; default %s\n&quot;</span>, ifname);</div>
<div class="line">    printf(<span class="stringliteral">&quot;\t[-p port]\tdestination port; default %d\n&quot;</span>, port);</div>
<div class="line">    printf(<span class="stringliteral">&quot;\t[-d dir]\tserver root directory; default %s\n&quot;</span>, dir);</div>
<div class="line">    printf(<span class="stringliteral">&quot;\t[-c cert]\tTLS certificate; default %s\n&quot;</span>, cert);</div>
<div class="line">    printf(<span class="stringliteral">&quot;\t[-k key]\tTLS key; default %s\n&quot;</span>, key);</div>
<div class="line">    printf(<span class="stringliteral">&quot;\t[-t timeout]\tidle timeout in seconds; default %&quot;</span> PRIu64 <span class="stringliteral">&quot;\n&quot;</span>,</div>
<div class="line">           timeout);</div>
<div class="line"><span class="preprocessor">#ifndef NDEBUG</span></div>
<div class="line"><span class="preprocessor"></span>    printf(<span class="stringliteral">&quot;\t[-v verbosity]\tverbosity level (0-%d, default %d)\n&quot;</span>, <a name="a2"></a><a class="code" href="warpcore_2lib_2include_2warpcore_2util_8h.html#a94c2776a2d1f9e44c3d327befe0d3bfe">DLEVEL</a>,</div>
<div class="line">           <a name="a3"></a><a class="code" href="warpcore_2lib_2include_2warpcore_2util_8h.html#ade0743d672f539b1615b3a5d3b79486b">util_dlevel</a>);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>    exit(0);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>cb_data {</div>
<div class="line">    <span class="keyword">struct </span><a name="_a4"></a><a class="code" href="structq__stream.html">q_stream</a> * s;</div>
<div class="line">    <span class="keyword">struct </span>q_conn * c;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a5"></a><a class="code" href="structw__engine.html">w_engine</a> * <a name="a6"></a><a class="code" href="fuzz_8c.html#a8bedaecc1f0b28f6c3ec357ca967b33a">w</a>;</div>
<div class="line">    <span class="keywordtype">int</span> dir;</div>
<div class="line">    uint32_t _dummy;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> send_err(<span class="keyword">const</span> <span class="keyword">struct</span> cb_data * <span class="keyword">const</span> d, <span class="keyword">const</span> uint16_t code)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> * msg;</div>
<div class="line">    <span class="keywordflow">switch</span> (code) {</div>
<div class="line">    <span class="keywordflow">case</span> 403:</div>
<div class="line">        msg = <span class="stringliteral">&quot;403 Forbidden&quot;</span>;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> 404:</div>
<div class="line">        msg = <span class="stringliteral">&quot;404 Not Found&quot;</span>;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">        msg = <span class="stringliteral">&quot;500 Internal Server Error&quot;</span>;</div>
<div class="line">    }</div>
<div class="line">    <a name="a7"></a><a class="code" href="warpcore_2lib_2include_2warpcore_2util_8h.html#a75fb9e13fe5fdbdbf4f0b7f34d25a887">warn</a>(<a name="a8"></a><a class="code" href="warpcore_2lib_2include_2warpcore_2util_8h.html#a735563036dced0b7d6cc98f97ea4978b">ERR</a>, <span class="stringliteral">&quot;%s&quot;</span>, msg);</div>
<div class="line"></div>
<div class="line">    <a name="a9"></a><a class="code" href="quant_8h.html#a3fe837399476c6ae443a5f17b5eb644f">q_write_str</a>(d-&gt;w, d-&gt;s, msg, <a name="a10"></a><a class="code" href="boot_8c.html#a48b3b9f7e0a27f07fa14bed55036fa3b">strlen</a>(msg), <span class="keyword">true</span>);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> serve_cb(http_parser * parser, <span class="keyword">const</span> <span class="keywordtype">char</span> * at, <span class="keywordtype">size_t</span> <a name="a11"></a><a class="code" href="t_2picotls_8c.html#a7360b55975153b822efc5217b7734e6a">len</a>)</div>
<div class="line">{</div>
<div class="line">    (void)parser;</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">struct </span>cb_data * <span class="keyword">const</span> d = parser-&gt;data;</div>
<div class="line">    <a class="code" href="warpcore_2lib_2include_2warpcore_2util_8h.html#a75fb9e13fe5fdbdbf4f0b7f34d25a887">warn</a>(<a name="a12"></a><a class="code" href="warpcore_2lib_2include_2warpcore_2util_8h.html#a12c2040f25d8e3a7b9e1c2024c618cb6">INF</a>, <span class="stringliteral">&quot;conn %s str %&quot;</span> PRId64 <span class="stringliteral">&quot; serving URL %.*s&quot;</span>, <a name="a13"></a><a class="code" href="quant_8h.html#abbe95c980e94c1ba72d110e86e0bb060">q_cid</a>(d-&gt;c),</div>
<div class="line">         <a name="a14"></a><a class="code" href="quant_8h.html#a0d5a178a6f02a949c935a8aa35805862">q_sid</a>(d-&gt;s), (<span class="keywordtype">int</span>)len, at);</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">char</span> path[MAXPATHLEN] = <span class="stringliteral">&quot;.&quot;</span>;</div>
<div class="line">    strncpy(&amp;path[*at == <span class="charliteral">&#39;/&#39;</span> ? 1 : 0], at, <a name="a15"></a><a class="code" href="handy_8h.html#a74e75242132eaabbc1c512488a135926">MIN</a>(len, <span class="keyword">sizeof</span>(path) - 1));</div>
<div class="line"></div>
<div class="line">    <span class="comment">// hacky way to prevent directory traversals</span></div>
<div class="line">    <span class="keywordflow">if</span> (strstr(path, <span class="stringliteral">&quot;..&quot;</span>))</div>
<div class="line">        <span class="keywordflow">return</span> send_err(d, 403);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// check if this is a &quot;GET /n&quot; request for random data</span></div>
<div class="line">    <span class="keyword">const</span> uint64_t n = (uint32_t)<a class="code" href="handy_8h.html#a74e75242132eaabbc1c512488a135926">MIN</a>(UINT64_MAX, strtoul(&amp;path[2], 0, 10));</div>
<div class="line">    <span class="keywordflow">if</span> (n) {</div>
<div class="line">        <span class="keyword">struct </span><a name="_a16"></a><a class="code" href="structw__iov__sq.html">w_iov_sq</a> out = <a name="a17"></a><a class="code" href="warpcore_8h.html#adb7cefb61123a68cf87f6e33270af1dc">w_iov_sq_initializer</a>(out);</div>
<div class="line">        <a name="a18"></a><a class="code" href="quant_8h.html#a47bc44fba1cbaf917110bc2c6c805c81">q_alloc</a>(d-&gt;w, &amp;out, n);</div>
<div class="line">        <span class="comment">// check whether we managed to allow enough buffers</span></div>
<div class="line">        <span class="keywordflow">if</span> (<a name="a19"></a><a class="code" href="warpcore_8h.html#acec933a0dba371ff10bd35397aed87e9">w_iov_sq_len</a>(&amp;out) != n) {</div>
<div class="line">            <a class="code" href="warpcore_2lib_2include_2warpcore_2util_8h.html#a75fb9e13fe5fdbdbf4f0b7f34d25a887">warn</a>(<a class="code" href="warpcore_2lib_2include_2warpcore_2util_8h.html#a735563036dced0b7d6cc98f97ea4978b">ERR</a>,</div>
<div class="line">                 <span class="stringliteral">&quot;could only allocate %&quot;</span> PRIu64 <span class="stringliteral">&quot;/%&quot;</span> PRIu64 <span class="stringliteral">&quot; bytes of buffer&quot;</span>,</div>
<div class="line">                 <a class="code" href="warpcore_8h.html#acec933a0dba371ff10bd35397aed87e9">w_iov_sq_len</a>(&amp;out), n);</div>
<div class="line">            <a name="a20"></a><a class="code" href="quant_8h.html#a4a7935a14e509d989eda300f16daf086">q_free</a>(&amp;out);</div>
<div class="line">            <span class="keywordflow">return</span> send_err(d, 500);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// randomize data</span></div>
<div class="line">        <span class="keyword">struct </span><a name="_a21"></a><a class="code" href="structw__iov.html">w_iov</a> * v = 0;</div>
<div class="line">        <span class="keywordtype">char</span> c = <span class="charliteral">&#39;A&#39;</span>;</div>
<div class="line">        <a name="a22"></a><a class="code" href="queue_8h.html#a761acddd0a38de75bf2777998f69add5">sq_foreach</a> (v, &amp;out, next) {</div>
<div class="line">            memset(v-&gt;<a name="a23"></a><a class="code" href="structw__iov.html#a2b33510e8a5b556deef4fb2b29b62a9e">buf</a>, c, v-&gt;<a name="a24"></a><a class="code" href="structw__iov.html#a362d3a1b5838b941b52350f86be23f4d">len</a>);</div>
<div class="line">            c = (c == <span class="charliteral">&#39;Z&#39;</span> ? <span class="charliteral">&#39;A&#39;</span> : c + 1);</div>
<div class="line">        }</div>
<div class="line">        <a name="a25"></a><a class="code" href="quant_8h.html#a84a599e3fc846bd85dae279762ca9851">q_write</a>(d-&gt;s, &amp;out, <span class="keyword">true</span>);</div>
<div class="line">        <a class="code" href="quant_8h.html#a4a7935a14e509d989eda300f16daf086">q_free</a>(&amp;out);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">struct </span>stat info;</div>
<div class="line">    <span class="keywordflow">if</span> (fstatat(d-&gt;dir, path, &amp;info, 0) == -1)</div>
<div class="line">        <span class="keywordflow">return</span> send_err(d, 404);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// if this a directory, look up its index</span></div>
<div class="line">    <span class="keywordflow">if</span> (info.st_mode &amp; S_IFDIR) {</div>
<div class="line">        strncat(path, <span class="stringliteral">&quot;/index.html&quot;</span>, <span class="keyword">sizeof</span>(path) - len - 1);</div>
<div class="line">        <span class="keywordflow">if</span> (fstatat(d-&gt;dir, path, &amp;info, 0) == -1)</div>
<div class="line">            <span class="keywordflow">return</span> send_err(d, 404);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> ((info.st_mode &amp; S_IFREG) == 0 || (info.st_mode &amp; S_IFLNK) == 0)</div>
<div class="line">        <span class="keywordflow">return</span> send_err(d, 403);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (info.st_size &gt;= UINT32_MAX)</div>
<div class="line">        <span class="keywordflow">return</span> send_err(d, 500);</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> f = openat(d-&gt;dir, path, O_RDONLY | O_CLOEXEC);</div>
<div class="line">    <a name="a26"></a><a class="code" href="warpcore_2lib_2include_2warpcore_2util_8h.html#a1011ec002411388144b5eea764f90d83">ensure</a>(f != -1, <span class="stringliteral">&quot;could not open %s&quot;</span>, path);</div>
<div class="line"></div>
<div class="line">    <a name="a27"></a><a class="code" href="quant_8h.html#add9fe9a3fc3b036c9a81e0d980744f81">q_write_file</a>(d-&gt;w, d-&gt;s, f, (uint32_t)info.st_size, <span class="keyword">true</span>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define MAXPORTS 16</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keywordtype">int</span> <a name="a28"></a><a class="code" href="klib_2test_2kavl__test_8c.html#a840291bc02cba5474a4cb46a9b9566fe">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> * argv[])</div>
<div class="line">{</div>
<div class="line">    uint64_t <a class="code" href="ping_8c.html#aae6e82a30c30cc902f1cd85dead37f6a">timeout</a> = 10;</div>
<div class="line"><span class="preprocessor">#ifndef NDEBUG</span></div>
<div class="line"><span class="preprocessor"></span>    <a class="code" href="warpcore_2lib_2include_2warpcore_2util_8h.html#ade0743d672f539b1615b3a5d3b79486b">util_dlevel</a> = <a class="code" href="warpcore_2lib_2include_2warpcore_2util_8h.html#a94c2776a2d1f9e44c3d327befe0d3bfe">DLEVEL</a>; <span class="comment">// default to maximum compiled-in verbosity</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordtype">char</span> ifname[IFNAMSIZ] = <span class="stringliteral">&quot;lo&quot;</span></div>
<div class="line"><span class="preprocessor">#ifndef __linux__</span></div>
<div class="line"><span class="preprocessor"></span>                            <span class="stringliteral">&quot;0&quot;</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>        ;</div>
<div class="line">    <span class="keywordtype">char</span> dir[MAXPATHLEN] = <span class="stringliteral">&quot;.&quot;</span>;</div>
<div class="line">    <span class="keywordtype">char</span> cert[MAXPATHLEN] = <span class="stringliteral">&quot;test/dummy.crt&quot;</span>;</div>
<div class="line">    <span class="keywordtype">char</span> key[MAXPATHLEN] = <span class="stringliteral">&quot;test/dummy.key&quot;</span>;</div>
<div class="line">    uint16_t port[MAXPORTS] = {4433, 4434};</div>
<div class="line">    <span class="keywordtype">size_t</span> num_ports = 0;</div>
<div class="line">    <span class="keywordtype">int</span> ch;</div>
<div class="line">    <span class="keywordtype">int</span> ret = 0;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> ((ch = getopt(argc, argv, <span class="stringliteral">&quot;hi:p:d:v:c:k:t:&quot;</span>)) != -1) {</div>
<div class="line">        <span class="keywordflow">switch</span> (ch) {</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;i&#39;</span>:</div>
<div class="line">            strncpy(ifname, optarg, <span class="keyword">sizeof</span>(ifname) - 1);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;d&#39;</span>:</div>
<div class="line">            strncpy(dir, optarg, <span class="keyword">sizeof</span>(dir) - 1);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;c&#39;</span>:</div>
<div class="line">            strncpy(cert, optarg, <span class="keyword">sizeof</span>(cert) - 1);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;k&#39;</span>:</div>
<div class="line">            strncpy(key, optarg, <span class="keyword">sizeof</span>(key) - 1);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;p&#39;</span>:</div>
<div class="line">            port[num_ports++] =</div>
<div class="line">                (uint16_t)<a class="code" href="handy_8h.html#a74e75242132eaabbc1c512488a135926">MIN</a>(UINT16_MAX, strtoul(optarg, 0, 10));</div>
<div class="line">            <a class="code" href="warpcore_2lib_2include_2warpcore_2util_8h.html#a1011ec002411388144b5eea764f90d83">ensure</a>(num_ports &lt; MAXPORTS, <span class="stringliteral">&quot;can only listen on at most %u ports&quot;</span>,</div>
<div class="line">                   MAXPORTS);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;t&#39;</span>:</div>
<div class="line">            timeout = <a class="code" href="handy_8h.html#a74e75242132eaabbc1c512488a135926">MIN</a>(600, strtoul(optarg, 0, 10)); <span class="comment">// 10 min</span></div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;v&#39;</span>:</div>
<div class="line"><span class="preprocessor">#ifndef NDEBUG</span></div>
<div class="line"><span class="preprocessor"></span>            <a class="code" href="warpcore_2lib_2include_2warpcore_2util_8h.html#ade0743d672f539b1615b3a5d3b79486b">util_dlevel</a> = (short)<a class="code" href="handy_8h.html#a74e75242132eaabbc1c512488a135926">MIN</a>(<a class="code" href="warpcore_2lib_2include_2warpcore_2util_8h.html#a94c2776a2d1f9e44c3d327befe0d3bfe">DLEVEL</a>, strtoul(optarg, 0, 10));</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;h&#39;</span>:</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;?&#39;</span>:</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            <a class="code" href="esni_8c.html#af1307a35da9646ba048347321301c323">usage</a>(<a name="a29"></a><a class="code" href="warpcore_2lib_2include_2warpcore_2util_8h.html#abf5f17d3254f2e930aee0dc34dbff071">basename</a>(argv[0]), ifname, port[0], dir, cert, key, timeout);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (num_ports == 0)</div>
<div class="line">        <span class="comment">// if no -p args were given, we listen on two ports by default</span></div>
<div class="line">        num_ports = 2;</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> dir_fd = open(dir, O_RDONLY | O_CLOEXEC);</div>
<div class="line">    <a class="code" href="warpcore_2lib_2include_2warpcore_2util_8h.html#a1011ec002411388144b5eea764f90d83">ensure</a>(dir_fd != -1, <span class="stringliteral">&quot;%s does not exist&quot;</span>, dir);</div>
<div class="line"></div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structw__engine.html">w_engine</a> * <span class="keyword">const</span> <a class="code" href="fuzz_8c.html#a8bedaecc1f0b28f6c3ec357ca967b33a">w</a> = <a name="a30"></a><a class="code" href="quant_8h.html#a9e861b437adeddbef368f166d9fc9730">q_init</a>(</div>
<div class="line">        ifname, &amp;(<span class="keyword">const</span> <span class="keyword">struct</span> <a name="_a31"></a><a class="code" href="structq__conf.html">q_conf</a>){</div>
<div class="line">                    .num_bufs = 100000, .tls_cert = cert, .tls_key = key});</div>
<div class="line">    <span class="keyword">struct </span>q_conn * conn[MAXPORTS];</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; num_ports; i++) {</div>
<div class="line">        conn[i] = <a name="a32"></a><a class="code" href="quant_8h.html#ac6e72671693d868a07bf17e6dd097632">q_bind</a>(w, port[i]);</div>
<div class="line">        <a class="code" href="warpcore_2lib_2include_2warpcore_2util_8h.html#a75fb9e13fe5fdbdbf4f0b7f34d25a887">warn</a>(<a name="a33"></a><a class="code" href="warpcore_2lib_2include_2warpcore_2util_8h.html#a49606be7356624568932ec81c0d429f4">DBG</a>, <span class="stringliteral">&quot;%s waiting on %s port %d&quot;</span>, <a class="code" href="warpcore_2lib_2include_2warpcore_2util_8h.html#abf5f17d3254f2e930aee0dc34dbff071">basename</a>(argv[0]), ifname,</div>
<div class="line">             port[i]);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">bool</span> first_conn = <span class="keyword">true</span>;</div>
<div class="line">    http_parser_settings settings = {.on_url = serve_cb};</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> (1) {</div>
<div class="line">        <span class="keyword">struct </span>q_conn * c = <a name="a34"></a><a class="code" href="quant_8h.html#a84a768c49cd352e1c8a109bda56ef3a6">q_rx_ready</a>(first_conn ? 0 : timeout);</div>
<div class="line">        <span class="keywordflow">if</span> (c == 0)</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        first_conn = <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// do we need to q_accept?</span></div>
<div class="line">        <span class="keywordflow">if</span> (<a name="a35"></a><a class="code" href="quant_8h.html#a76ddd1770d74ef5233f2f2f9aaa73dfa">q_is_new_serv_conn</a>(c))</div>
<div class="line">            <a name="a36"></a><a class="code" href="quant_8h.html#a5b452d2c7658c801b4182547d75880a4">q_accept</a>(&amp;(<span class="keyword">struct</span> <a name="_a37"></a><a class="code" href="structq__conn__conf.html">q_conn_conf</a>){</div>
<div class="line">                .idle_timeout = <a class="code" href="ping_8c.html#aae6e82a30c30cc902f1cd85dead37f6a">timeout</a>,</div>
<div class="line">                .enable_spinbit = <span class="keyword">true</span>,</div>
<div class="line">            });</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">while</span> (1) {</div>
<div class="line">            <span class="comment">// do we need to handle a request?</span></div>
<div class="line">            <span class="keyword">struct </span>cb_data d = {.c = c, .w = <a class="code" href="fuzz_8c.html#a8bedaecc1f0b28f6c3ec357ca967b33a">w</a>, .dir = dir_fd};</div>
<div class="line">            http_parser parser = {.data = &amp;d};</div>
<div class="line"></div>
<div class="line">            http_parser_init(&amp;parser, HTTP_REQUEST);</div>
<div class="line">            <span class="keyword">struct </span><a class="code" href="structw__iov__sq.html">w_iov_sq</a> q = <a class="code" href="warpcore_8h.html#adb7cefb61123a68cf87f6e33270af1dc">w_iov_sq_initializer</a>(q);</div>
<div class="line">            <span class="keyword">struct </span><a class="code" href="structq__stream.html">q_stream</a> * s = <a name="a38"></a><a class="code" href="quant_8h.html#a3eca43a72005c71781fd6139f1f8d798">q_read</a>(c, &amp;q, <span class="keyword">false</span>);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (<a name="a39"></a><a class="code" href="queue_8h.html#af94ce05fbbab07bec6cce3d81b6d5cbf">sq_empty</a>(&amp;q))</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">            d.s = s;</div>
<div class="line">            <span class="keyword">struct </span><a class="code" href="structw__iov.html">w_iov</a> * v = 0;</div>
<div class="line">            <a class="code" href="queue_8h.html#a761acddd0a38de75bf2777998f69add5">sq_foreach</a> (v, &amp;q, next) {</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">size_t</span> parsed = http_parser_execute(</div>
<div class="line">                    &amp;parser, &amp;settings, (<span class="keywordtype">char</span> *)v-&gt;<a class="code" href="structw__iov.html#a2b33510e8a5b556deef4fb2b29b62a9e">buf</a>, v-&gt;<a class="code" href="structw__iov.html#a362d3a1b5838b941b52350f86be23f4d">len</a>);</div>
<div class="line">                <span class="keywordflow">if</span> (parsed != v-&gt;<a class="code" href="structw__iov.html#a362d3a1b5838b941b52350f86be23f4d">len</a>) {</div>
<div class="line">                    <a class="code" href="warpcore_2lib_2include_2warpcore_2util_8h.html#a75fb9e13fe5fdbdbf4f0b7f34d25a887">warn</a>(<a class="code" href="warpcore_2lib_2include_2warpcore_2util_8h.html#a735563036dced0b7d6cc98f97ea4978b">ERR</a>, <span class="stringliteral">&quot;HTTP parser error: %.*s&quot;</span>, (<span class="keywordtype">int</span>)(v-&gt;<a class="code" href="structw__iov.html#a362d3a1b5838b941b52350f86be23f4d">len</a> - parsed),</div>
<div class="line">                         &amp;v-&gt;<a class="code" href="structw__iov.html#a2b33510e8a5b556deef4fb2b29b62a9e">buf</a>[parsed]);</div>
<div class="line">                    ret = 1;</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">if</span> (<a name="a40"></a><a class="code" href="quant_8h.html#ae13d7142befff1e56bdab2813a120c3e">q_peer_has_closed_stream</a>(s)) {</div>
<div class="line">                    <a name="a41"></a><a class="code" href="quant_8h.html#a01444581bd34af25498d1cb8fc3a0a92">q_close_stream</a>(s);</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            <a class="code" href="quant_8h.html#a4a7935a14e509d989eda300f16daf086">q_free</a>(&amp;q);</div>
<div class="line">        }</div>
<div class="line">        <a name="a42"></a><a class="code" href="quant_8h.html#a795c32a858382068fa5b5cf25af69a77">q_close</a>(c);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a name="a43"></a><a class="code" href="quant_8h.html#a22f108de18d6532a45071881f7fb4dca">q_cleanup</a>(w);</div>
<div class="line">    <a class="code" href="warpcore_2lib_2include_2warpcore_2util_8h.html#a75fb9e13fe5fdbdbf4f0b7f34d25a887">warn</a>(<a class="code" href="warpcore_2lib_2include_2warpcore_2util_8h.html#a49606be7356624568932ec81c0d429f4">DBG</a>, <span class="stringliteral">&quot;%s exiting&quot;</span>, <a class="code" href="warpcore_2lib_2include_2warpcore_2util_8h.html#abf5f17d3254f2e930aee0dc34dbff071">basename</a>(argv[0]));</div>
<div class="line">    <span class="keywordflow">return</span> ret;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Wed Feb 13 2019 14:28:07 for quant by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
